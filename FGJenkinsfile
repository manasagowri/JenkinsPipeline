properties([
    parameters([
        string(defaultValue: '', description: 'Enter the rhbuild name. For ex: 4.2-rhel-8', name: 'rhbuild', trim: true),
        string(defaultValue: '', description: 'Enter the inventory file with path. For ex: rhel-8.2-server-x86_64. If left empty, the build will be triggered for latest versions of both RHEL-7 and RHEL-8', name: 'inventory', trim: true),
        string(defaultValue: '', description: 'Enter the repo details, if the build needs be triggered for any specific RHCS version.', name: 'rhs_ceph_repo', trim: true),
        string(defaultValue: '', description: 'Enter the container image URL if applicable. ', name: 'container_image', trim: true),
        string(defaultValue: 'red-hat-storage/cephci', description: 'Enter the github repo link for the build. Default will be red-hat-storage/cephci.', name: 'github_repo_link', trim: true),
        string(defaultValue: 'master', description: 'Enter the git branch to be used for the build. Default will be master.', name: 'git_branch', trim: true),
        string(defaultValue: '', description: 'Enter the suite name with path for which build needs to be triggered. For ex: sanity_install_prereq', name: 'suite_name', trim: true),
        string(defaultValue: '', description: 'Enter the conf file with path for the build. For ex: install_prereq_fullconfig', name: 'global_conf', trim: true),
        extendedChoice(bindings: '', defaultValue: 'a', description: '', descriptionPropertyValue: '', groovyClasspath: '', groovyScript: '''def pars = ['A','S','D','F','G','H']
           List<String> artifacts = new ArrayList<String>()
           for(item in pars){
              artifacts.add(item)
           }
        return artifacts''', multiSelectDelimiter: ',', name: 'suite_name', quoteValue: false, saveJSONParameterToFile: false, type: 'PT_MULTI_SELECT', visibleItemCount: 3)
   ])
])


// extendedChoice(bindings: '', defaultValue: 'all', description: '', descriptionPropertyValue: '', groovyClasspath: '', groovyScript: '''import groovy.io.FileType
     //def fileList = []
     // checkout([$class: \'GitSCM\', branches: [[name: \'*/main\']], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[url: \'https://github.com/red-hat-storage/cephci.git\']]])
     // def suite_dir = new File("cephci/suites/luminous/ansible")
     // echo "I got executed"
     // dir.eachFileRecurse (FileType.FILES) { file ->
     //    fileList << file
     // }
      //fileList = [As, DF, SD, SC, ASD]
      //return fileList
//''', multiSelectDelimiter: ',', name: 'suite_name', quoteValue: false, saveJSONParameterToFile: false, type: 'PT_CHECKBOX', visibleItemCount: 3)



args = ['rhbuild' : "${params.rhbuild}", 'inventory' : "conf/inventory/${params.inventory}.yaml", 'rhs_ceph_repo' : "${params.rhs_ceph_repo}" , 'container_image' : "${params.container_image}" ,
        'github_repo_link' : "${params.github_repo_link}" , 'git_branch' : "${params.git_branch}" , 'suite_name' : "suites/nautilus/ansible/${params.suite_name}.yaml" ,
        'global_conf' : "conf/nautilus/ansible/${params.global_conf}.yaml"]

node{
    stage('Execute groovy script'){
        echo "Execute groovy script with the following parameters:"
        //echo args
        script{
            echo "Inside script"
            //exeuteCLI(args)
            library identifier: 'JenkinsPipeline@main', retriever: modernSCM([$class: 'GitSCMSource', credentialsId: '', remote: 'https://github.com/manasagowri/JenkinsPipeline', traits: [gitBranchDiscovery()]])
            ExecuteCephCI(args)
            echo "Scripts done"
        }
    }
}

def exeuteCLI(args){
   echo "Inside execute CLI"
   checkout([$class: 'GitSCM', branches: [[name: args['git_branch']]], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[url: 'https://github.com/' + args['github_repo_link']]]])
   echo "Check out complete"
   def cli = 'python3 -m venv .;source ./bin/activate;pip install -r requirements.txt;ls -lt ;  python run.py --rhbuild ' + args['rhbuild'] + ' --global-conf ' + args['global_conf'] + ' --osp-cred ~/osp-cred-ci-2.yaml --inventory '
              + args['inventory'] + ' --suite ' + args['suite_name'] + ' --log-level info --ignore-latest-container --insecure-registry '
   echo "CLI defined"
   echo cli
   if(args['rhs-ceph-repo']?.trim()){
        cli = cli + '--rhs-ceph-repo ' + args['rhs_ceph_repo']
   }
   echo "CLI modified"
   echo cli
   sh cli
}
